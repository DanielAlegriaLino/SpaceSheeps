<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Satellite Proximity Alert</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Courier New', monospace;
      background: #0a0e17;
      color: #c8d6e5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ---- Header & Nav ---- */
    header {
      text-align: center;
      padding: 1.2rem 1rem 0;
      border-bottom: 1px solid #1e2a3a;
      background: #0a0e17;
      position: relative;
      z-index: 100;
    }

    header h1 {
      font-size: 1.5rem;
      color: #00d2ff;
      letter-spacing: 3px;
      text-transform: uppercase;
    }

    header .subtitle {
      color: #6b7b8d;
      margin-top: 0.3rem;
      font-size: 0.8rem;
    }

    .nav-tabs {
      display: flex;
      justify-content: center;
      gap: 0;
      margin-top: 1rem;
    }

    .nav-tab {
      background: none;
      border: none;
      color: #6b7b8d;
      font-family: inherit;
      font-size: 0.8rem;
      padding: 0.6rem 1.5rem;
      cursor: pointer;
      letter-spacing: 1px;
      text-transform: uppercase;
      border-bottom: 2px solid transparent;
      transition: color 0.2s, border-color 0.2s;
    }

    .nav-tab:hover {
      color: #c8d6e5;
    }

    .nav-tab.active {
      color: #00d2ff;
      border-bottom-color: #00d2ff;
    }

    /* ---- Layout ---- */
    .app-layout {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 300px;
      min-width: 300px;
      background: #111927;
      border-right: 1px solid #1e2a3a;
      padding: 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .sidebar h2 {
      font-size: 0.85rem;
      color: #00d2ff;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .panel {
      background: #0d1420;
      border: 1px solid #1e2a3a;
      border-radius: 8px;
      padding: 1rem;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      margin-bottom: 0.7rem;
    }

    .field label {
      font-size: 0.7rem;
      color: #6b7b8d;
      text-transform: uppercase;
    }

    .field input,
    .field select {
      background: #0a0e17;
      border: 1px solid #1e2a3a;
      color: #c8d6e5;
      padding: 0.45rem 0.6rem;
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.8rem;
      width: 100%;
    }

    .field input:focus,
    .field select:focus {
      outline: none;
      border-color: #00d2ff;
      box-shadow: 0 0 8px rgba(0, 210, 255, 0.2);
    }

    .btn-row {
      display: flex;
      gap: 0.5rem;
    }

    .btn {
      background: #00d2ff;
      color: #0a0e17;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.8rem;
      font-weight: bold;
      cursor: pointer;
      letter-spacing: 1px;
      text-transform: uppercase;
      flex: 1;
      transition: background 0.2s, box-shadow 0.2s;
    }

    .btn:hover {
      background: #00b8e6;
      box-shadow: 0 2px 12px rgba(0, 210, 255, 0.3);
    }

    .btn:disabled {
      background: #2a3a4a;
      color: #6b7b8d;
      cursor: not-allowed;
      box-shadow: none;
    }

    .btn-secondary {
      background: transparent;
      color: #00d2ff;
      border: 1px solid #00d2ff;
    }

    .btn-secondary:hover {
      background: rgba(0, 210, 255, 0.1);
    }

    /* Stats */
    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 0.4rem 0;
      border-bottom: 1px solid rgba(30, 42, 58, 0.5);
      font-size: 0.75rem;
    }

    .stat-row:last-child {
      border-bottom: none;
    }

    .stat-label {
      color: #6b7b8d;
      text-transform: uppercase;
    }

    .stat-value {
      color: #00d2ff;
      font-weight: bold;
    }

    .stat-value.alert {
      color: #ff4444;
    }

    /* Legend */
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.65rem;
      margin-bottom: 0.25rem;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* ---- Alert Banner ---- */
    .alert-banner {
      display: none;
      background: #1a0a0a;
      border: 1px solid #ff4444;
      border-radius: 8px;
      padding: 0.8rem 1rem;
      animation: pulse-border 2s infinite;
    }

    .alert-banner.visible {
      display: block;
    }

    .alert-banner h3 {
      color: #ff4444;
      font-size: 0.85rem;
      margin-bottom: 0.3rem;
    }

    .alert-banner p {
      font-size: 0.75rem;
      color: #e8a0a0;
    }

    @keyframes pulse-border {

      0%,
      100% {
        border-color: #ff4444;
      }

      50% {
        border-color: #ff8888;
      }
    }

    /* ---- Main Content Area ---- */
    .main-content {
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    .view {
      display: none;
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }

    .view.active {
      display: block;
    }

    /* ---- Table View ---- */
    #view-table {
      overflow-y: auto;
      padding: 1rem;
    }

    .sat-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    .sat-table th {
      text-align: left;
      color: #6b7b8d;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 0.7rem;
      padding: 0.6rem 0.5rem;
      border-bottom: 1px solid #1e2a3a;
      position: sticky;
      top: 0;
      background: #0a0e17;
    }

    .sat-table td {
      padding: 0.5rem;
      border-bottom: 1px solid #111927;
    }

    .sat-table tr.close td {
      color: #ff4444;
      font-weight: bold;
    }

    .sat-table tr.medium td {
      color: #ffaa00;
    }

    .sat-table tr:hover td {
      background: rgba(0, 210, 255, 0.05);
    }

    .distance-badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 3px;
      font-size: 0.75rem;
      font-weight: bold;
    }

    .distance-badge.close {
      background: #3a0a0a;
      color: #ff4444;
    }

    .distance-badge.medium {
      background: #2a1a00;
      color: #ffaa00;
    }

    .distance-badge.far {
      background: #0a1a2a;
      color: #00d2ff;
    }

    .table-summary {
      margin-top: 0.8rem;
      padding-top: 0.6rem;
      border-top: 1px solid #1e2a3a;
      font-size: 0.8rem;
      color: #6b7b8d;
    }

    .table-empty {
      text-align: center;
      padding: 3rem;
      color: #6b7b8d;
      font-size: 0.85rem;
    }

    /* ---- 2D Map View ---- */
    #view-map {
      background: #0a0e17;
    }

    #worldMapCanvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* ---- 3D Globe View ---- */
    #view-globe {
      background: #000;
    }

    /* ---- Tooltip ---- */
    .sat-tooltip {
      position: fixed;
      z-index: 200;
      background: rgba(10, 14, 23, 0.98);
      border: 2px solid #00d2ff;
      border-radius: 6px;
      padding: 0.7rem 0.9rem;
      pointer-events: none;
      display: none;
      min-width: 180px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.7);
    }

    .sat-tooltip.visible {
      display: block;
    }

    .sat-tooltip .tt-name {
      font-size: 0.85rem;
      font-weight: bold;
      color: #00d2ff;
      margin-bottom: 0.3rem;
    }

    .sat-tooltip .tt-info {
      font-size: 0.7rem;
      color: #c8d6e5;
      line-height: 1.4;
    }

    .sat-tooltip .tt-dist {
      font-size: 1rem;
      font-weight: bold;
      color: #fff;
      margin-top: 0.3rem;
    }

    .sat-tooltip .tt-dist.close {
      color: #ff4444;
    }

    .sat-tooltip .tt-dist.medium {
      color: #ffaa00;
    }

    /* ---- Status Bar ---- */
    .status-bar {
      background: #111927;
      border-top: 1px solid #1e2a3a;
      padding: 0.4rem 1rem;
      font-size: 0.75rem;
      color: #6b7b8d;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
    }

    .status-bar.error {
      color: #ff4444;
    }

    .status-bar .refresh-info {
      color: #4a5a6a;
    }

    .status-bar .refresh-info.active {
      color: #00d2ff;
    }

    /* ---- Video View ---- */
    .video-container {
      padding: 1.5rem;
      height: 100%;
      overflow-y: auto;
    }

    .video-header {
      display: flex;
      justify-content: center;
      margin-bottom: 1.2rem;
    }

    .video-header .btn {
      flex: 0;
      padding: 0.6rem 1.5rem;
      font-size: 0.85rem;
    }

    .video-header .btn.ai-active {
      background: #ff4444;
      box-shadow: 0 0 16px rgba(255, 68, 68, 0.4);
    }

    .video-header .btn.ai-active:hover {
      background: #e03030;
    }

    .video-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.2rem;
    }

    .video-card {
      background: #111927;
      border: 1px solid #1e2a3a;
      border-radius: 8px;
      overflow: hidden;
    }

    .video-card h3 {
      color: #00d2ff;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 0.6rem 0.8rem;
      border-bottom: 1px solid #1e2a3a;
    }

    .video-wrap {
      position: relative;
    }

    .video-wrap video {
      width: 100%;
      display: block;
    }

    .video-wrap video.vid-hidden {
      position: absolute;
      top: 0;
      left: 0;
      visibility: hidden;
    }

    /* ---- Responsive ---- */
    @media (max-width: 768px) {
      .app-layout {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        min-width: 0;
        max-height: 40vh;
        border-right: none;
        border-bottom: 1px solid #1e2a3a;
      }
    }
  </style>
</head>

<body>
  <header>
    <h1>Satellite Proximity Alert</h1>
    <p class="subtitle">Real-time satellite tracking & proximity detection</p>
    <div class="nav-tabs">
      <button class="nav-tab active" data-view="table">Table</button>
      <button class="nav-tab" data-view="map">2D Map</button>
      <button class="nav-tab" data-view="globe">3D Globe</button>
      <button class="nav-tab" data-view="video">Video</button>
      <button class="nav-tab" data-view="camera">Camera</button>
    </div>
  </header>

  <div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <!-- Observer Position -->
      <div class="panel">
        <h2>Observer Position</h2>
        <div class="field">
          <label>Latitude</label>
          <input type="number" id="lat" step="any" placeholder="41.39">
        </div>
        <div class="field">
          <label>Longitude</label>
          <input type="number" id="lon" step="any" placeholder="2.17">
        </div>
        <div class="field">
          <label>Altitude (m)</label>
          <input type="number" id="alt" value="2000000" step="any">
        </div>
        <div class="field">
          <label>Category</label>
          <select id="category">
            <option value="0">All</option>
            <option value="1">Brightest</option>
            <option value="2">ISS</option>
            <option value="3">Weather</option>
            <option value="5">GPS</option>
            <option value="6">Science</option>
            <option value="12">Starlink</option>
            <option value="15">Education</option>
            <option value="18">Amateur Radio</option>
            <option value="22">GPS Operational</option>
          </select>
        </div>
        <div class="field">
          <label>Search Radius (&deg;)</label>
          <input type="number" id="radius" value="70" min="0" max="90">
        </div>
        <div class="field">
          <label>Alert Threshold (km)</label>
          <input type="number" id="threshold" value="1000" min="1">
        </div>
        <div class="field">
          <label>N2YO API Key</label>
          <input type="text" id="apiKey" value="KKPFNP-MBTEZH-DRXW8E-5NCO">
        </div>
        <div class="field">
          <label>Auto-refresh (seconds)</label>
          <input type="number" id="refreshInterval" value="30" min="5" max="300">
        </div>
        <div class="btn-row">
          <button class="btn btn-secondary" id="geolocateBtn">GPS</button>
          <button class="btn" id="scanBtn">Scan</button>
        </div>
        <div class="btn-row" style="margin-top:0.4rem">
          <button class="btn btn-secondary" id="toggleRefreshBtn" style="width:100%">Enable Auto-refresh</button>
        </div>
      </div>

      <!-- Alert Banner -->
      <div class="alert-banner" id="alertBanner">
        <h3 id="alertTitle">PROXIMITY ALERT</h3>
        <p id="alertMsg"></p>
      </div>

      <!-- Statistics -->
      <div class="panel">
        <h2>Statistics</h2>
        <div class="stat-row">
          <span class="stat-label">Total Satellites</span>
          <span class="stat-value" id="statTotal">0</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Within Threshold</span>
          <span class="stat-value alert" id="statClose">0</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Nearest Distance</span>
          <span class="stat-value" id="statNearest">&mdash;</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Last Update</span>
          <span class="stat-value" id="statLastUpdate">Never</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Observer</span>
          <span class="stat-value" id="statObserver">Not set</span>
        </div>
      </div>

      <!-- Legend -->
      <div class="panel">
        <h2>Legend</h2>
        <div class="legend-item">
          <div class="legend-dot" style="background:#ff4444; box-shadow:0 0 6px #ff4444;"></div>
          <span>Debris (name contains "DEB")</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot" style="background:#4a9eff; box-shadow:0 0 6px #4a9eff;"></div>
          <span>Satellite (non-debris)</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot" style="background:#00ff88; box-shadow:0 0 8px #00ff88;"></div>
          <span>Your Position</span>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Table View -->
      <div id="view-table" class="view active">
        <div class="table-empty" id="tableEmpty">Enter your position or use GPS, then press Scan.</div>
      </div>

      <!-- 2D Map View -->
      <div id="view-map" class="view">
        <canvas id="worldMapCanvas"></canvas>
      </div>

      <!-- 3D Globe View -->
      <div id="view-globe" class="view"></div>

      <!-- Video View -->
      <div id="view-video" class="view">
        <div class="video-container">
          <div class="video-header">
            <button class="btn" id="aiToggleBtn" onclick="toggleAI()">Enable AI Detection</button>
          </div>
          <div class="video-grid">
            <div class="video-card">
              <h3>Video 1</h3>
              <div class="video-wrap">
                <video id="vid1" src="/videos/daniela_video.mp4" autoplay muted loop playsinline></video>
                <video id="vid1d" class="vid-hidden" src="/videos/daniela_video_detected.mp4" autoplay muted loop
                  playsinline></video>
              </div>
            </div>
            <div class="video-card">
              <h3>Video 2</h3>
              <div class="video-wrap">
                <video id="vid2" src="/videos/chino_video.mp4" autoplay muted loop playsinline></video>
                <video id="vid2d" class="vid-hidden" src="/videos/chino_video_detected.mp4" autoplay muted loop
                  playsinline></video>
              </div>
            </div>
          </div>

          <!-- AI Pipeline Diagram -->
          <div
            style="background:linear-gradient(135deg,#0d1420 0%,#0a1628 50%,#0d1420 100%);border:1px solid #00d2ff33;border-radius:12px;padding:2rem 2rem 1.8rem;margin-top:1.2rem;text-align:center;position:relative;overflow:hidden;">
            <!-- Glow effect top -->
            <div
              style="position:absolute;top:-40px;left:50%;transform:translateX(-50%);width:200px;height:80px;background:radial-gradient(ellipse,rgba(0,210,255,0.15),transparent);pointer-events:none;">
            </div>

            <div
              style="font-size:0.7rem;color:#00d2ff;text-transform:uppercase;letter-spacing:3px;margin-bottom:0.3rem;">
              Powered by</div>
            <div style="font-size:1.6rem;font-weight:bold;color:#fff;letter-spacing:2px;margin-bottom:0.2rem;">
              SpaceSheeps AI Engine</div>
            <div style="font-size:0.85rem;color:#6b7b8d;margin-bottom:1.5rem;">Our AI watches the sky for you and spots
              satellites automatically</div>

            <!-- Pipeline -->
            <div
              style="display:flex;align-items:center;justify-content:center;gap:0.6rem;flex-wrap:wrap;margin-bottom:1.5rem;">
              <div
                style="background:#111927;border:1px solid #1e2a3a;border-radius:8px;padding:0.8rem 1.2rem;min-width:100px;">
                <div style="font-size:1.8rem;">üìπ</div>
                <div style="font-size:0.8rem;color:#c8d6e5;margin-top:0.3rem;font-weight:bold;">Video Feed</div>
                <div style="font-size:0.6rem;color:#6b7b8d;margin-top:0.1rem;">Live camera footage</div>
              </div>
              <div style="color:#00d2ff;font-size:1.5rem;">&#9654;</div>
              <div
                style="background:#111927;border:1px solid #00d2ff55;border-radius:8px;padding:0.8rem 1.2rem;min-width:100px;box-shadow:0 0 20px rgba(0,210,255,0.08);">
                <div style="font-size:1.8rem;">üß†</div>
                <div style="font-size:0.8rem;color:#00d2ff;margin-top:0.3rem;font-weight:bold;">AI Brain</div>
                <div style="font-size:0.6rem;color:#6b7b8d;margin-top:0.1rem;">Analyzes every frame</div>
              </div>
              <div style="color:#00d2ff;font-size:1.5rem;">&#9654;</div>
              <div
                style="background:#111927;border:1px solid #1e2a3a;border-radius:8px;padding:0.8rem 1.2rem;min-width:100px;">
                <div style="font-size:1.8rem;">üéØ</div>
                <div style="font-size:0.8rem;color:#c8d6e5;margin-top:0.3rem;font-weight:bold;">Detection</div>
                <div style="font-size:0.6rem;color:#6b7b8d;margin-top:0.1rem;">Finds and marks satellites</div>
              </div>
              <div style="color:#00d2ff;font-size:1.5rem;">&#9654;</div>
              <div
                style="background:linear-gradient(135deg,#0a1a2a,#0d2235);border:1px solid #00d2ff;border-radius:8px;padding:0.8rem 1.2rem;min-width:100px;box-shadow:0 0 25px rgba(0,210,255,0.15);">
                <div style="font-size:1.8rem;">üì°</div>
                <div style="font-size:0.8rem;color:#00d2ff;margin-top:0.3rem;font-weight:bold;">Alert</div>
                <div style="font-size:0.6rem;color:#6b7b8d;margin-top:0.1rem;">Warns you instantly</div>
              </div>
            </div>

            <!-- Stats -->
            <div style="display:flex;justify-content:center;gap:2rem;margin-bottom:1.5rem;flex-wrap:wrap;">
              <div>
                <div style="font-size:1.4rem;font-weight:bold;color:#00d2ff;">95.2%</div>
                <div style="font-size:0.65rem;color:#6b7b8d;text-transform:uppercase;letter-spacing:1px;">Accuracy</div>
              </div>
              <div>
                <div style="font-size:1.4rem;font-weight:bold;color:#00d2ff;">30 FPS</div>
                <div style="font-size:0.65rem;color:#6b7b8d;text-transform:uppercase;letter-spacing:1px;">Real-time
                </div>
              </div>
              <div>
                <div style="font-size:1.4rem;font-weight:bold;color:#00d2ff;">6.2 MB</div>
                <div style="font-size:0.65rem;color:#6b7b8d;text-transform:uppercase;letter-spacing:1px;">Lightweight
                </div>
              </div>
              <div>
                <div style="font-size:1.4rem;font-weight:bold;color:#00d2ff;">GPU/CPU</div>
                <div style="font-size:0.65rem;color:#6b7b8d;text-transform:uppercase;letter-spacing:1px;">Runs anywhere
                </div>
              </div>
            </div>

            <!-- CTA -->
            <a href="/models/yolov8_satellite.pt" download class="btn"
              style="display:inline-block;flex:none;padding:0.7rem 2.5rem;text-decoration:none;font-size:0.95rem;letter-spacing:2px;box-shadow:0 0 30px rgba(0,210,255,0.3);border-radius:6px;">Download
              AI Model</a>
            <div style="font-size:0.65rem;color:#4a5a6a;margin-top:0.6rem;">Free &middot; Open source &middot; Ready to
              use</div>
          </div>
        </div>
      </div>

      <!-- Camera View -->
      <div id="view-camera" class="view">
        <div class="camera-container"
          style="display:flex;flex-direction:column;align-items:center;justify-content:flex-start;height:100%;padding:1.5rem;overflow-y:auto;">
          <div class="camera-header" style="margin-bottom:1rem;text-align:center;">
            <h2
              style="color:#00d2ff;font-size:1.3rem;letter-spacing:2px;text-transform:uppercase;margin-bottom:0.5rem;">
              AI Camera Detection</h2>
            <p style="color:#6b7b8d;font-size:0.85rem;">Real-time satellite detection using SpaceSheeps AI</p>
          </div>

          <!-- AI Camera Feed -->
          <div id="aiCameraWrap" class="camera-wrap"
            style="position:relative;max-width:900px;width:100%;min-height:500px;background:#111927;border:2px solid #00d2ff;border-radius:12px;overflow:hidden;box-shadow:0 0 40px rgba(0,210,255,0.25);">
            <img id="aiCameraFeed" src="" alt="AI Camera Feed"
              style="width:100%;height:100%;min-height:500px;display:none;background:#0a0e17;object-fit:contain;">
            <div id="aiCameraPlaceholder"
              style="position:absolute;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#0d1420;">
              <div style="font-size:3rem;margin-bottom:0.8rem;">ÔøΩÔ∏è</div>
              <p style="color:#6b7b8d;font-size:0.95rem;margin-bottom:0.5rem;">AI Camera Feed</p>
              <p
                style="color:#4a5a6a;font-size:0.8rem;margin-bottom:1rem;text-align:center;padding:0 1rem;max-width:400px;">
                Start the server with camera enabled, then click the button below.
              </p>
              <code
                style="color:#00d2ff;background:#0a0e17;padding:0.5rem 1rem;border-radius:4px;margin-bottom:1rem;font-size:0.8rem;">python landing/server.py --camera 0</code>
              <button class="btn" id="connectAiBtn" style="flex:none;padding:0.6rem 2rem;font-size:0.9rem;">Connect to
                Camera</button>
            </div>
            <div id="aiCameraError"
              style="display:none;position:absolute;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#0d1420;">
              <div style="font-size:2.5rem;margin-bottom:0.8rem;">‚ö†Ô∏è</div>
              <p style="color:#ff4444;font-size:0.9rem;text-align:center;padding:0 1rem;max-width:400px;"
                id="aiCameraErrorMsg">Cannot connect. Make sure server is running with --camera flag.</p>
              <button class="btn btn-secondary" id="retryAiBtn"
                style="flex:none;margin-top:1rem;padding:0.5rem 1.5rem;">Retry</button>
            </div>
            <!-- AI Mode Badge -->
            <div id="aiBadge"
              style="display:none;position:absolute;top:10px;right:10px;background:rgba(0,210,255,0.9);color:#0a0e17;padding:0.3rem 0.8rem;border-radius:4px;font-size:0.7rem;font-weight:bold;letter-spacing:1px;">
              AI DETECTION ACTIVE
            </div>
          </div>

          <div class="camera-controls"
            style="display:flex;gap:1rem;margin-top:1rem;flex-wrap:wrap;justify-content:center;">
            <button class="btn btn-secondary" id="disconnectCameraBtn"
              style="display:none;padding:0.5rem 1.5rem;">Disconnect</button>
          </div>
          <div style="margin-top:1rem;text-align:center;max-width:600px;">
            <p style="color:#4a5a6a;font-size:0.75rem;">The AI processes your camera feed in real-time, detecting
              satellites and space debris.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tooltip -->
  <div class="sat-tooltip" id="satTooltip">
    <div class="tt-name" id="tooltipName"></div>
    <div class="tt-info" id="tooltipInfo"></div>
    <div class="tt-dist" id="tooltipDistance"></div>
  </div>

  <!-- Status Bar -->
  <div class="status-bar" id="statusBar">
    <span id="statusMsg">Ready</span>
    <span class="refresh-info" id="refreshInfo">Auto-refresh: Off</span>
  </div>

  <!-- Video AI toggle -->
  <script>
    let aiEnabled = false;

    // Keep detected videos synced to originals continuously
    (function syncLoop() {
      const vid1 = document.getElementById('vid1');
      const vid1d = document.getElementById('vid1d');
      const vid2 = document.getElementById('vid2');
      const vid2d = document.getElementById('vid2d');
      if (vid1 && vid1d && vid2 && vid2d) {
        if (!aiEnabled) {
          if (Math.abs(vid1d.currentTime - vid1.currentTime) > 0.1) vid1d.currentTime = vid1.currentTime;
          if (Math.abs(vid2d.currentTime - vid2.currentTime) > 0.1) vid2d.currentTime = vid2.currentTime;
        } else {
          if (Math.abs(vid1.currentTime - vid1d.currentTime) > 0.1) vid1.currentTime = vid1d.currentTime;
          if (Math.abs(vid2.currentTime - vid2d.currentTime) > 0.1) vid2.currentTime = vid2d.currentTime;
        }
      }
      requestAnimationFrame(syncLoop);
    })();

    function toggleAI() {
      aiEnabled = !aiEnabled;
      const btn = document.getElementById('aiToggleBtn');
      const vid1 = document.getElementById('vid1');
      const vid1d = document.getElementById('vid1d');
      const vid2 = document.getElementById('vid2');
      const vid2d = document.getElementById('vid2d');

      if (aiEnabled) {
        btn.classList.add('ai-active');
        btn.textContent = 'Disable AI Detection';
        vid1.classList.add('vid-hidden');
        vid1d.classList.remove('vid-hidden');
        vid2.classList.add('vid-hidden');
        vid2d.classList.remove('vid-hidden');
      } else {
        btn.classList.remove('ai-active');
        btn.textContent = 'Enable AI Detection';
        vid1.classList.remove('vid-hidden');
        vid1d.classList.add('vid-hidden');
        vid2.classList.remove('vid-hidden');
        vid2d.classList.add('vid-hidden');
      }
    }
  </script>

  <!-- Camera functionality -->
  <script>
    // =========================================================================
    // AI CAMERA FEED
    // =========================================================================
    const AI_STREAM_URL = '/camera_feed';

    document.getElementById('connectAiBtn').addEventListener('click', connectToCamera);
    document.getElementById('retryAiBtn').addEventListener('click', connectToCamera);
    document.getElementById('disconnectCameraBtn').addEventListener('click', disconnectCamera);

    function connectToCamera() {
      const aiImg = document.getElementById('aiCameraFeed');
      const placeholder = document.getElementById('aiCameraPlaceholder');
      const errorDiv = document.getElementById('aiCameraError');
      const badge = document.getElementById('aiBadge');
      const disconnectBtn = document.getElementById('disconnectCameraBtn');

      // Show loading state
      errorDiv.style.display = 'none';
      placeholder.innerHTML = '<div style="font-size:2rem;margin-bottom:1rem;">‚è≥</div><p style="color:#00d2ff;">Connecting to camera...</p>';

      // Handle error
      aiImg.onerror = function () {
        aiImg.style.display = 'none';
        placeholder.style.display = 'none';
        errorDiv.style.display = 'flex';
        badge.style.display = 'none';
        disconnectBtn.style.display = 'none';
      };

      // Handle success
      aiImg.onload = function () {
        placeholder.style.display = 'none';
        errorDiv.style.display = 'none';
        aiImg.style.display = 'block';
        badge.style.display = 'block';
        disconnectBtn.style.display = 'inline-block';
      };

      // Set the stream URL
      aiImg.src = AI_STREAM_URL + '?t=' + Date.now();
    }

    function disconnectCamera() {
      const aiImg = document.getElementById('aiCameraFeed');
      const placeholder = document.getElementById('aiCameraPlaceholder');
      const errorDiv = document.getElementById('aiCameraError');
      const badge = document.getElementById('aiBadge');
      const disconnectBtn = document.getElementById('disconnectCameraBtn');

      aiImg.src = '';
      aiImg.style.display = 'none';
      badge.style.display = 'none';
      disconnectBtn.style.display = 'none';
      errorDiv.style.display = 'none';

      placeholder.innerHTML = `
        <div style="font-size:3rem;margin-bottom:0.8rem;">üõ∞Ô∏è</div>
        <p style="color:#6b7b8d;font-size:0.95rem;margin-bottom:0.5rem;">AI Camera Feed</p>
        <p style="color:#4a5a6a;font-size:0.8rem;margin-bottom:1rem;text-align:center;padding:0 1rem;max-width:400px;">
          Start the server with camera enabled, then click the button below.
        </p>
        <code style="color:#00d2ff;background:#0a0e17;padding:0.5rem 1rem;border-radius:4px;margin-bottom:1rem;font-size:0.8rem;">python landing/server.py --camera 0</code>
        <button class="btn" id="connectAiBtn" style="flex:none;padding:0.6rem 2rem;font-size:0.9rem;" onclick="connectToCamera()">Connect to Camera</button>
      `;
      placeholder.style.display = 'flex';
    }
  </script>

  <!-- Three.js (loaded only when globe tab is activated) -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
    }
  }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // =========================================================================
    // SHARED STATE
    // =========================================================================
    const EARTH_RADIUS_KM = 6371.0;
    let satellites = [];
    let observerPos = { lat: null, lon: null, alt: 0 };
    let autoRefreshInterval = null;
    let refreshCountdownInterval = null;
    let currentView = 'table';

    // =========================================================================
    // NAV TABS
    // =========================================================================
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        tab.classList.add('active');
        const view = tab.dataset.view;
        document.getElementById('view-' + view).classList.add('active');
        currentView = view;

        if (view === 'globe' && !globeInitialized) initGlobe();
        if (view === 'map') { resizeMapCanvas(); drawMap(); }
        if (view === 'globe' && globeRenderer) onGlobeResize();
      });
    });

    // =========================================================================
    // BUTTONS
    // =========================================================================
    document.getElementById('geolocateBtn').addEventListener('click', geolocate);
    document.getElementById('scanBtn').addEventListener('click', scan);
    document.getElementById('toggleRefreshBtn').addEventListener('click', toggleAutoRefresh);

    // =========================================================================
    // GEOLOCATION
    // =========================================================================
    function geolocate() {
      if (!navigator.geolocation) {
        showStatus("Geolocation not supported.", true);
        return;
      }
      const btn = document.getElementById("geolocateBtn");
      btn.disabled = true;
      btn.textContent = "‚Ä¶";

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          document.getElementById("lat").value = pos.coords.latitude.toFixed(5);
          document.getElementById("lon").value = pos.coords.longitude.toFixed(5);
          if (pos.coords.altitude != null) {
            document.getElementById("alt").value = pos.coords.altitude.toFixed(1);
          }
          btn.disabled = false;
          btn.textContent = "GPS";
        },
        (err) => {
          showStatus("Geolocation error: " + err.message, true);
          btn.disabled = false;
          btn.textContent = "GPS";
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }

    // =========================================================================
    // DISTANCE CALC (ECEF)
    // =========================================================================
    function computeDistanceKm(obsLat, obsLon, obsAltKm, satLat, satLon, satAltKm) {
      const toRad = d => d * Math.PI / 180;
      const oLatR = toRad(obsLat), oLonR = toRad(obsLon);
      const sLatR = toRad(satLat), sLonR = toRad(satLon);
      const rObs = EARTH_RADIUS_KM + obsAltKm;
      const rSat = EARTH_RADIUS_KM + satAltKm;
      const ox = rObs * Math.cos(oLatR) * Math.cos(oLonR);
      const oy = rObs * Math.cos(oLatR) * Math.sin(oLonR);
      const oz = rObs * Math.sin(oLatR);
      const sx = rSat * Math.cos(sLatR) * Math.cos(sLonR);
      const sy = rSat * Math.cos(sLatR) * Math.sin(sLonR);
      const sz = rSat * Math.sin(sLatR);
      return Math.sqrt((ox - sx) ** 2 + (oy - sy) ** 2 + (oz - sz) ** 2);
    }

    // =========================================================================
    // SCAN (shared ‚Äî populates all views)
    // =========================================================================
    async function scan() {
      const lat = parseFloat(document.getElementById("lat").value);
      const lon = parseFloat(document.getElementById("lon").value);
      const alt = parseFloat(document.getElementById("alt").value) || 0;
      const radius = parseInt(document.getElementById("radius").value) || 70;
      const category = document.getElementById("category").value;
      const threshold = parseFloat(document.getElementById("threshold").value) || 1000;
      const apiKey = document.getElementById("apiKey").value.trim();

      if (isNaN(lat) || isNaN(lon)) {
        showStatus("Enter valid latitude and longitude.", true);
        return;
      }

      observerPos = { lat, lon, alt };

      const btn = document.getElementById("scanBtn");
      btn.disabled = true;
      btn.textContent = "‚Ä¶";
      showStatus("Fetching satellites from N2YO‚Ä¶", false);
      document.getElementById("alertBanner").classList.remove("visible");

      const obsAltKm = alt / 1000.0;

      try {
        const apiUrl = `/api/above/${lat}/${lon}/${alt}/${radius}/${category}?apiKey=${apiKey}`;
        const resp = await fetch(apiUrl);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();

        const satData = data.above || [];
        if (satData.length === 0) {
          showStatus("No satellites found above your position.", false);
          satellites = [];
          updateAllViews();
          btn.disabled = false;
          btn.textContent = "Scan";
          return;
        }

        satellites = satData.map(sat => {
          const satLat = sat.satlat || 0;
          const satLon = sat.satlng || 0;
          const satAltKm = sat.satalt || 0;
          const distance = computeDistanceKm(lat, lon, obsAltKm, satLat, satLon, satAltKm);
          return { name: sat.satname || "Unknown", noradId: sat.satid || "?", satLat, satLon, satAltKm, distance };
        });

        satellites.sort((a, b) => a.distance - b.distance);
        satellites = satellites.filter(s => s.distance <= 30000);

        if (satellites.length === 0) {
          showStatus("No satellites within 30,000 km.", false);
          updateAllViews();
          btn.disabled = false;
          btn.textContent = "Scan";
          return;
        }

        const closeSats = satellites.filter(s => s.distance <= threshold);
        showAlert(closeSats, threshold);
        showStatus(`Found ${satellites.length} satellites`, false);
        updateAllViews();

      } catch (err) {
        showStatus("Error: " + err.message, true);
        satellites = [];
        updateAllViews();
      }

      btn.disabled = false;
      btn.textContent = "Scan";
    }

    function updateAllViews() {
      const threshold = parseFloat(document.getElementById("threshold").value) || 1000;
      updateStats();
      renderTable(threshold);
      drawMap();
      if (globeInitialized) updateGlobe(threshold);
    }

    // =========================================================================
    // ALERT
    // =========================================================================
    function showAlert(closeSats, threshold) {
      const banner = document.getElementById("alertBanner");
      if (closeSats.length === 0) { banner.classList.remove("visible"); return; }
      const nearest = closeSats[0];
      document.getElementById("alertTitle").textContent =
        `PROXIMITY ALERT ‚Äî ${closeSats.length} satellite${closeSats.length > 1 ? "s" : ""} within ${threshold} km`;
      document.getElementById("alertMsg").textContent =
        `Nearest: ${nearest.name} (NORAD ${nearest.noradId}) at ${nearest.distance.toFixed(1)} km`;
      banner.classList.add("visible");

      if (Notification.permission === "granted") {
        new Notification("Satellite Proximity Alert", { body: `${nearest.name} at ${nearest.distance.toFixed(1)} km` });
      } else if (Notification.permission !== "denied") {
        Notification.requestPermission();
      }
    }

    // =========================================================================
    // STATS
    // =========================================================================
    function updateStats() {
      const threshold = parseFloat(document.getElementById("threshold").value) || 1000;
      const closeSats = satellites.filter(s => s.distance <= threshold);
      document.getElementById("statTotal").textContent = satellites.length;
      document.getElementById("statClose").textContent = closeSats.length;
      document.getElementById("statNearest").textContent =
        satellites.length > 0 ? satellites[0].distance.toFixed(1) + " km" : "\u2014";
      document.getElementById("statLastUpdate").textContent = new Date().toLocaleTimeString();
      if (observerPos.lat !== null) {
        document.getElementById("statObserver").textContent =
          `${observerPos.lat.toFixed(2)}\u00b0, ${observerPos.lon.toFixed(2)}\u00b0`;
      }
    }

    // =========================================================================
    // AUTO-REFRESH
    // =========================================================================
    function toggleAutoRefresh() {
      const btn = document.getElementById("toggleRefreshBtn");
      const info = document.getElementById("refreshInfo");

      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        clearInterval(refreshCountdownInterval);
        autoRefreshInterval = null;
        refreshCountdownInterval = null;
        btn.textContent = "Enable Auto-refresh";
        info.textContent = "Auto-refresh: Off";
        info.classList.remove("active");
      } else {
        const secs = parseInt(document.getElementById("refreshInterval").value) || 30;
        let countdown = secs;
        autoRefreshInterval = setInterval(() => { scan(); countdown = secs; }, secs * 1000);
        refreshCountdownInterval = setInterval(() => {
          countdown = Math.max(0, countdown - 1);
          info.textContent = `Next refresh: ${countdown}s`;
        }, 1000);
        btn.textContent = "Disable Auto-refresh";
        info.textContent = `Next refresh: ${secs}s`;
        info.classList.add("active");
      }
    }

    // =========================================================================
    // STATUS BAR
    // =========================================================================
    function showStatus(msg, isError) {
      const bar = document.getElementById("statusBar");
      document.getElementById("statusMsg").textContent = msg;
      if (isError) bar.classList.add("error");
      else bar.classList.remove("error");
    }

    // =========================================================================
    // TOOLTIP (shared by map & globe)
    // =========================================================================
    function showTooltip(sat, x, y) {
      const threshold = parseFloat(document.getElementById("threshold").value) || 1000;
      const tip = document.getElementById("satTooltip");
      document.getElementById("tooltipName").textContent = sat.name;
      document.getElementById("tooltipInfo").innerHTML =
        `NORAD: ${sat.noradId}<br>Alt: ${sat.satAltKm.toFixed(1)} km<br>Pos: ${sat.satLat.toFixed(2)}\u00b0, ${sat.satLon.toFixed(2)}\u00b0`;
      const distEl = document.getElementById("tooltipDistance");
      distEl.textContent = `${sat.distance.toFixed(1)} km`;
      distEl.className = 'tt-dist';
      if (sat.distance <= threshold) distEl.classList.add('close');
      else if (sat.distance <= threshold * 3) distEl.classList.add('medium');
      tip.style.left = (x + 15) + 'px';
      tip.style.top = (y + 15) + 'px';
      tip.classList.add('visible');
    }

    function hideTooltip() {
      document.getElementById("satTooltip").classList.remove("visible");
    }

    function esc(s) { const d = document.createElement("div"); d.textContent = s; return d.innerHTML; }

    function isDebris(sat) { return sat.name.toLowerCase().includes('deb'); }

    // =========================================================================
    // TABLE VIEW
    // =========================================================================
    function renderTable(threshold) {
      const container = document.getElementById("view-table");
      if (satellites.length === 0) {
        container.innerHTML = '<div class="table-empty">No satellite data. Press Scan to fetch.</div>';
        return;
      }
      const closeSats = satellites.filter(r => r.distance <= threshold);
      let html = `<table class="sat-table">
        <thead><tr><th>Satellite</th><th>NORAD</th><th>Alt (km)</th><th>Lat</th><th>Lon</th><th>Distance</th></tr></thead><tbody>`;
      for (const r of satellites) {
        const deb = isDebris(r);
        const nameColor = deb ? 'color:#ff4444' : 'color:#4a9eff';
        const badge = r.distance <= threshold ? "close" : r.distance <= threshold * 3 ? "medium" : "far";
        html += `<tr>
          <td style="${nameColor};font-weight:bold">${esc(r.name)}</td>
          <td>${esc(String(r.noradId))}</td>
          <td>${r.satAltKm.toFixed(1)}</td>
          <td>${r.satLat.toFixed(2)}\u00b0</td>
          <td>${r.satLon.toFixed(2)}\u00b0</td>
          <td><span class="distance-badge ${badge}">${r.distance.toFixed(1)} km</span></td>
        </tr>`;
      }
      html += `</tbody></table>`;
      html += `<div class="table-summary">Total: ${satellites.length} &nbsp;|&nbsp; Within threshold: ${closeSats.length}</div>`;
      container.innerHTML = html;
    }

    // =========================================================================
    // 2D MAP VIEW
    // =========================================================================
    let mapCanvas, mapCtx;

    function initMap() {
      mapCanvas = document.getElementById("worldMapCanvas");
      mapCtx = mapCanvas.getContext("2d");
      resizeMapCanvas();
      window.addEventListener("resize", () => { if (currentView === 'map') { resizeMapCanvas(); drawMap(); } });
      mapCanvas.addEventListener("mousemove", handleMapMouse);
      mapCanvas.addEventListener("mouseleave", hideTooltip);
    }

    function resizeMapCanvas() {
      if (!mapCanvas) return;
      const container = document.getElementById("view-map");
      mapCanvas.width = container.clientWidth;
      mapCanvas.height = container.clientHeight;
    }

    function latLonToCanvas(lat, lon) {
      return {
        x: ((lon + 180) / 360) * mapCanvas.width,
        y: ((90 - lat) / 180) * mapCanvas.height,
      };
    }

    function drawMap() {
      if (!mapCtx || !mapCanvas.width) return;
      const ctx = mapCtx;
      ctx.fillStyle = '#0a0e17';
      ctx.fillRect(0, 0, mapCanvas.width, mapCanvas.height);

      // Grid
      ctx.strokeStyle = 'rgba(30, 42, 58, 0.3)';
      ctx.lineWidth = 1;
      for (let lat = -80; lat <= 80; lat += 20) {
        const p1 = latLonToCanvas(lat, -180), p2 = latLonToCanvas(lat, 180);
        ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
      }
      for (let lon = -180; lon <= 180; lon += 30) {
        const p1 = latLonToCanvas(-90, lon), p2 = latLonToCanvas(90, lon);
        ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
      }
      // Equator
      ctx.strokeStyle = 'rgba(0, 210, 255, 0.2)';
      const eq1 = latLonToCanvas(0, -180), eq2 = latLonToCanvas(0, 180);
      ctx.beginPath(); ctx.moveTo(eq1.x, eq1.y); ctx.lineTo(eq2.x, eq2.y); ctx.stroke();

      // Continents
      drawContinents(ctx);

      // Satellites
      const threshold = parseFloat(document.getElementById("threshold").value) || 1000;
      satellites.forEach(sat => {
        const pos = latLonToCanvas(sat.satLat, sat.satLon);
        const deb = isDebris(sat);
        const color = deb ? '#ff4444' : '#4a9eff';
        const r = deb ? 5 : 3;
        ctx.fillStyle = color;
        ctx.beginPath(); ctx.arc(pos.x, pos.y, r, 0, Math.PI * 2); ctx.fill();
        if (deb) {
          ctx.shadowBlur = 12; ctx.shadowColor = '#ff4444'; ctx.fill(); ctx.shadowBlur = 0;
        }
        sat._mx = pos.x; sat._my = pos.y; sat._mr = r;
      });

      // Observer
      if (observerPos.lat !== null && observerPos.lon !== null) {
        const op = latLonToCanvas(observerPos.lat, observerPos.lon);

        // Outer glow ring
        ctx.strokeStyle = 'rgba(0, 255, 100, 0.25)'; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.arc(op.x, op.y, 22, 0, Math.PI * 2); ctx.stroke();

        // Mid glow ring
        ctx.strokeStyle = 'rgba(0, 255, 100, 0.4)'; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.arc(op.x, op.y, 14, 0, Math.PI * 2); ctx.stroke();

        // Main dot with heavy glow
        ctx.fillStyle = '#00ff44';
        ctx.shadowBlur = 30; ctx.shadowColor = '#00ff44';
        ctx.beginPath(); ctx.arc(op.x, op.y, 8, 0, Math.PI * 2); ctx.fill();
        ctx.fill(); // double-fill for stronger glow
        ctx.shadowBlur = 0;

        // Crosshair
        ctx.strokeStyle = '#00ff44'; ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(op.x - 18, op.y); ctx.lineTo(op.x - 10, op.y);
        ctx.moveTo(op.x + 10, op.y); ctx.lineTo(op.x + 18, op.y);
        ctx.moveTo(op.x, op.y - 18); ctx.lineTo(op.x, op.y - 10);
        ctx.moveTo(op.x, op.y + 10); ctx.lineTo(op.x, op.y + 18);
        ctx.stroke();

        // Label
        ctx.fillStyle = '#00ff44'; ctx.font = 'bold 11px Courier New';
        ctx.textAlign = 'center';
        ctx.fillText('YOU', op.x, op.y - 28);
      }
    }

    function drawContinents(ctx) {
      ctx.strokeStyle = 'rgba(107, 123, 141, 0.3)';
      ctx.fillStyle = 'rgba(30, 42, 58, 0.2)';
      ctx.lineWidth = 1;
      const continents = [
        [{ lat: 70, lon: -170 }, { lat: 50, lon: -140 }, { lat: 30, lon: -120 }, { lat: 20, lon: -100 }, { lat: 10, lon: -80 }, { lat: 15, lon: -70 }, { lat: 45, lon: -60 }, { lat: 60, lon: -80 }, { lat: 70, lon: -100 }],
        [{ lat: 10, lon: -80 }, { lat: 0, lon: -75 }, { lat: -20, lon: -70 }, { lat: -40, lon: -70 }, { lat: -55, lon: -68 }, { lat: -40, lon: -60 }, { lat: -20, lon: -50 }, { lat: 0, lon: -50 }, { lat: 10, lon: -60 }],
        [{ lat: 70, lon: 20 }, { lat: 60, lon: 10 }, { lat: 45, lon: -10 }, { lat: 35, lon: -10 }, { lat: 35, lon: 30 }, { lat: 45, lon: 40 }, { lat: 60, lon: 40 }, { lat: 70, lon: 30 }],
        [{ lat: 35, lon: -10 }, { lat: 10, lon: -15 }, { lat: -35, lon: 20 }, { lat: -35, lon: 50 }, { lat: 10, lon: 50 }, { lat: 30, lon: 30 }],
        [{ lat: 70, lon: 40 }, { lat: 60, lon: 60 }, { lat: 70, lon: 100 }, { lat: 60, lon: 140 }, { lat: 40, lon: 140 }, { lat: 20, lon: 120 }, { lat: 10, lon: 100 }, { lat: 20, lon: 70 }, { lat: 35, lon: 50 }],
        [{ lat: -10, lon: 115 }, { lat: -35, lon: 115 }, { lat: -40, lon: 140 }, { lat: -35, lon: 150 }, { lat: -10, lon: 145 }]
      ];
      continents.forEach(c => {
        ctx.beginPath();
        c.forEach((pt, i) => { const p = latLonToCanvas(pt.lat, pt.lon); i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y); });
        ctx.closePath(); ctx.fill(); ctx.stroke();
      });
    }

    function handleMapMouse(e) {
      const rect = mapCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left, y = e.clientY - rect.top;
      let found = null;
      for (const sat of satellites) {
        const dx = x - (sat._mx || 0), dy = y - (sat._my || 0);
        if (Math.sqrt(dx * dx + dy * dy) <= (sat._mr || 3) + 5) { found = sat; break; }
      }
      if (found) {
        showTooltip(found, e.clientX, e.clientY);
        mapCanvas.style.cursor = 'pointer';
      } else {
        hideTooltip();
        mapCanvas.style.cursor = 'default';
      }
    }

    // =========================================================================
    // 3D GLOBE VIEW
    // =========================================================================
    let globeInitialized = false;
    let globeScene, globeCamera, globeRenderer, globeControls;
    let earthMesh, satelliteMeshes = [], observerMesh = null;
    let globeRaycaster, globeMouse;
    let hoveredSat = null;

    function initGlobe() {
      if (globeInitialized) return;
      globeInitialized = true;

      const container = document.getElementById('view-globe');
      globeScene = new THREE.Scene();
      globeCamera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 100000);
      globeCamera.position.set(15000, 8000, 15000);

      globeRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      globeRenderer.setSize(container.clientWidth, container.clientHeight);
      globeRenderer.setPixelRatio(window.devicePixelRatio);
      container.appendChild(globeRenderer.domElement);

      globeControls = new OrbitControls(globeCamera, globeRenderer.domElement);
      globeControls.enableDamping = true;
      globeControls.dampingFactor = 0.05;
      globeControls.minDistance = 7000;
      globeControls.maxDistance = 30000;

      globeRaycaster = new THREE.Raycaster();
      globeMouse = new THREE.Vector2();

      // Lights
      const sun = new THREE.DirectionalLight(0xffffff, 1.2);
      sun.position.set(5, 3, 5);
      globeScene.add(sun);
      globeScene.add(new THREE.AmbientLight(0x404040, 0.8));

      // Stars
      const starGeo = new THREE.BufferGeometry();
      const starPos = new Float32Array(5000 * 3);
      for (let i = 0; i < starPos.length; i += 3) {
        const r = 50000 + Math.random() * 50000;
        const th = Math.random() * Math.PI * 2;
        const ph = Math.acos(2 * Math.random() - 1);
        starPos[i] = r * Math.sin(ph) * Math.cos(th);
        starPos[i + 1] = r * Math.sin(ph) * Math.sin(th);
        starPos[i + 2] = r * Math.cos(ph);
      }
      starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
      globeScene.add(new THREE.Points(starGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 2, sizeAttenuation: false })));

      // Earth
      const earthGeo = new THREE.SphereGeometry(EARTH_RADIUS_KM, 64, 64);
      const earthMat = new THREE.MeshPhongMaterial({ color: 0x2233ff, emissive: 0x112244, shininess: 5 });
      earthMesh = new THREE.Mesh(earthGeo, earthMat);
      globeScene.add(earthMesh);

      new THREE.TextureLoader().load('textures/earth_day.jpg',
        tex => { earthMesh.material.map = tex; earthMesh.material.needsUpdate = true; },
        undefined, () => { });

      // Atmosphere
      const atmosGeo = new THREE.SphereGeometry(EARTH_RADIUS_KM * 1.01, 64, 64);
      const atmosMat = new THREE.ShaderMaterial({
        vertexShader: `varying vec3 vNormal; void main(){ vNormal=normalize(normalMatrix*normal); gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0); }`,
        fragmentShader: `varying vec3 vNormal; void main(){ float i=pow(0.6-dot(vNormal,vec3(0,0,1)),2.0); gl_FragColor=vec4(0.3,0.6,1.0,1.0)*i; }`,
        blending: THREE.AdditiveBlending, side: THREE.BackSide, transparent: true
      });
      globeScene.add(new THREE.Mesh(atmosGeo, atmosMat));

      // Events
      window.addEventListener('resize', () => { if (currentView === 'globe') onGlobeResize(); });
      globeRenderer.domElement.addEventListener('mousemove', onGlobeMouseMove);
      globeRenderer.domElement.addEventListener('mouseleave', () => { hideTooltip(); hoveredSat = null; });

      // Render existing data
      const threshold = parseFloat(document.getElementById("threshold").value) || 1000;
      if (satellites.length > 0) updateGlobe(threshold);

      // Animation loop
      let pulseTime = 0;
      function animate() {
        requestAnimationFrame(animate);
        globeControls.update();
        if (observerMesh) { pulseTime += 0.05; const s = 1 + Math.sin(pulseTime) * 0.2; observerMesh.scale.set(s, s, s); }
        globeRenderer.render(globeScene, globeCamera);
      }
      animate();
    }

    function latLonAltToVec3(lat, lon, altKm) {
      const r = EARTH_RADIUS_KM + altKm;
      const phi = (90 - lat) * Math.PI / 180;
      const theta = (lon + 180) * Math.PI / 180;
      return new THREE.Vector3(
        -r * Math.sin(phi) * Math.cos(theta),
        r * Math.cos(phi),
        r * Math.sin(phi) * Math.sin(theta)
      );
    }

    function updateGlobe(threshold) {
      if (!globeInitialized) return;

      // Clear old satellites
      satelliteMeshes.forEach(m => { globeScene.remove(m); m.geometry.dispose(); m.material.dispose(); });
      satelliteMeshes = [];

      satellites.forEach(sat => {
        const pos = latLonAltToVec3(sat.satLat, sat.satLon, sat.satAltKm);
        const deb = isDebris(sat);
        let color = deb ? 0xff4444 : 0x4a9eff;
        let emI = deb ? 2.5 : 1.2;
        const geo = new THREE.SphereGeometry(100, 16, 16);
        const mat = new THREE.MeshLambertMaterial({ color, emissive: color, emissiveIntensity: emI });
        const mesh = new THREE.Mesh(geo, mat);
        mesh.position.copy(pos);
        mesh.userData.satellite = sat;
        globeScene.add(mesh);
        satelliteMeshes.push(mesh);
      });

      // Observer
      if (observerMesh) { globeScene.remove(observerMesh); observerMesh.geometry.dispose(); observerMesh.material.dispose(); observerMesh = null; }
      if (observerPos.lat !== null) {
        const pos = latLonAltToVec3(observerPos.lat, observerPos.lon, observerPos.alt / 1000);
        const geo = new THREE.SphereGeometry(180, 16, 16);
        const mat = new THREE.MeshLambertMaterial({ color: 0x00ff44, emissive: 0x00ff44, emissiveIntensity: 5.0 });
        observerMesh = new THREE.Mesh(geo, mat);
        observerMesh.position.copy(pos);
        globeScene.add(observerMesh);

        // Add a glow ring around observer
        const ringGeo = new THREE.RingGeometry(250, 350, 32);
        const ringMat = new THREE.MeshBasicMaterial({ color: 0x00ff44, side: THREE.DoubleSide, transparent: true, opacity: 0.4 });
        const ring = new THREE.Mesh(ringGeo, ringMat);
        ring.position.copy(pos);
        ring.lookAt(0, 0, 0);
        globeScene.add(ring);
        satelliteMeshes.push(ring); // so it gets cleaned up on next update
      }
    }

    function onGlobeResize() {
      const container = document.getElementById('view-globe');
      globeCamera.aspect = container.clientWidth / container.clientHeight;
      globeCamera.updateProjectionMatrix();
      globeRenderer.setSize(container.clientWidth, container.clientHeight);
    }

    function onGlobeMouseMove(e) {
      const rect = globeRenderer.domElement.getBoundingClientRect();
      globeMouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
      globeMouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
      globeRaycaster.setFromCamera(globeMouse, globeCamera);
      const hits = globeRaycaster.intersectObjects(satelliteMeshes);
      if (hits.length > 0) {
        const sat = hits[0].object.userData.satellite;
        if (sat !== hoveredSat) { hoveredSat = sat; showTooltip(sat, e.clientX, e.clientY); }
        globeRenderer.domElement.style.cursor = 'pointer';
      } else {
        if (hoveredSat) { hoveredSat = null; hideTooltip(); }
        globeRenderer.domElement.style.cursor = 'grab';
      }
    }

    // =========================================================================
    // INIT
    // =========================================================================
    window.addEventListener('load', () => {
      initMap();
      drawMap();
    });
  </script>
</body>

</html>